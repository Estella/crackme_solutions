#include <windows.h>
#include <stdint.h>

static const uint64_t bignum_tabl[] =
{
0xE959F0B52D30097B, 0xA32020A271D9386F, 0xA8DECA1B3FBF02CB, 0xF4CC7084179D7B3F,
0xC2454139D5BC92FF, 0x9922594940BCD237, 0x96F5F551154DBBE7, 0xD6AA883ED1B1016B,
0xD6DDF4A6B941851F, 0x829FAA3FA47D6F27, 0xC8BC0B42F3D94F23, 0xE27B9653F2C3CDF7,
0xE7BC4FB83D82A1C3, 0xE1752EFD2F506CAF, 0xCEA611D76EFADD97, 0x8171D6617B7A43F3,
0xAA550AEA10813E1B, 0xB1736700473EDD8F, 0xB0040E596C35351B, 0x9580930937BCC40F,
0x8E8C40AC114F3A5F, 0xCCFAED0C4943B1F7, 0xC8F1EAC8456F9917, 0xF16E51F34EEAC4AF,
0xE3C63841181F80F7, 0xDCCBB7313D1F991F, 0xC61FDDE4F4C35EAB, 0xD33EE35595BE3FAF,
0x90AE07D4AAC38943, 0xA72038BF2EA066DF, 0xFA843453258C115F, 0xF0D62E9E93A92BEB,
0xEB79B1BC650CD073, 0xD7A232FEC8FAEDA3, 0x81D6970E82279A23, 0xDAF9CA6EF781C2A7,
0xEACE406DB661367B, 0xA6BAFEC1FE2EC3FF, 0xF55B96168FC0F14F, 0xB669B10AD4F3D53B,
0xFD053952B386CA83, 0xA51D7D91D7D27237, 0xE782F4FC20F845BF, 0xEE2E16B89631D34F,
0xE1DDDBDFFBB96EB3, 0xC779B0D15B46F6C3, 0xB5A785279CEBB09F, 0x949F5BD57B7747CB,
0xC9658065A3FB9E3B, 0xCF9AD96E1B09DFA7, 0xD43A083B82C600CF, 0x8DF8D3E595F45023,
0xFAEDADD3A7DD51BF, 0xAB46818AFF2E4353, 0x9CA889DA4C76685F, 0xAE1BD6669A68534F,
0xB4EF7E5F28C49CBB, 0x899080B081FCED5F, 0x8C0FFDCEFBF710EF, 0x83075F4C4771A447,
0x93055E77B9FA684F, 0xC8C6595D32C9EC5F, 0xB7B3FBBFA08A0B0B, 0x8C85E95E3FA55663,
0xE2AC61E73C9C0737, 0xF1592E1DEF1C69FB, 0xA906060C72553AE3, 0xB6EFB22DE07DEB03,
0xD7BF39923BC13917, 0xE39610C506781A93, 0xBC0886975ABAB5C3, 0xF068C8C1380326DF,
0xD4E73832537746BF, 0xD6BD99CFB874820B, 0xAF03319C06B7D7CF, 0x96DCC61B47B08B0B,
0x89CE582166984C23, 0xCCEA589423FD8583, 0xFC6F0426DA0E3BA3, 0xE0C32ADF301AAB9B,
0xF68F0A742D38694B, 0xEE7BF2F730C8C1FF, 0x90862A0F15B0127F, 0xC96AB05E1C2B3853,
0x821EBEB17CCD6A9F, 0xADF0FB792EA39BB3, 0xA51AF13989B90597, 0xFECF1B7B55B991CB,
0xCC5FEBCD580CDD07, 0xDCF690A4F6960BFB, 0xD294A6AB2E9FC673, 0xFD378FC389D454CF,
0xB314DE681D7DDCD7, 0xA9903A8E31EC908B, 0xF57C8D0169227407, 0xB14861A62395521F,
0xC4493A3703F5C457, 0xAF8E63B8490125DF, 0x901EFA17D5440E7F, 0x937754BB559A8FC7,
0x900DDC0660681B97, 0xB114EAA49BEE0CDF, 0xA9C8F7591A990567, 0xD63D0854F96155CB,
0xB03E00D1F97F2A6F, 0xC14E89760D6C498F, 0xAE4A1161724A8F83, 0xFE63B90D579A6C5B,
0xC2080AD9B60118F7, 0xC40C61E23EA55A8F, 0xD8771C7ED08A268F, 0xBAE9C294EA11D7D3,
0xA01E7E7A0EE35287, 0xB8FDDE86B93E236F, 0x883466BBF599A317, 0xC8D2DCC4B1674B53,
0xB96F9ED7E8036657, 0x82DBC41C406365D3, 0xDC32A889B61D70AB, 0xBB31FA4B426C28B7,
0xA0C9FB30D46E2467, 0x8745814E03B1364F, 0x85F7427756AA58C7, 0x8D01441DF139F967,
0xBE53BAA7FA07E16F, 0xAE5CD19A0E457EDF, 0xF1C639E093AB90EF, 0xBF1CBA98B1FDFEE3
};

typedef union
{
	uint64_t rx;
	uint32_t ex;
	uint16_t x;
	struct { uint8_t lo, hi; }b;
} Register;

extern void _stdcall d2k2_crackme08_hash(DWORD* output, DWORD input_len, DWORD* input, DWORD output_len);

int8_t crc32_rotr = 8;
int8_t crc32_rotl = 0x10;

void process_serial(char *name, char *serial_out)
{
	TCHAR usrname[0x80] = { 0 };
	uint8_t hash2[0x80] = { 0 };
	TCHAR hash_ascii[0x80] = { 0 };

	DWORD namelen = 0x80;
	GetUserNameA(usrname, &namelen);
	namelen = strlen(usrname);
	
	d2k2_crackme08_hash(hash2, namelen, usrname, namelen);

	for (int i = 0; i < 8; i++) {
		wsprintf(&hash_ascii[i * 2], "%02X", hash2[i]);
	}


	Register EB, EA, ED;
	int bignum_tabloff1 = 8;
	int bignum_tabloff2 = 0x10;

	while (namelen != 0)
	{
		DWORD* bufptr = hash2;
		EA.ex = *bufptr;
		EA.ex = _rotr(EA.ex, 8);
		EB.ex = *(DWORD*)(bufptr + 1);
		EA.ex = _rotl(EA.ex, 4);
		EA.ex ^= EB.ex;
		ED.ex = EA.ex % 0x80;
		EA.ex = EA.ex / 0x80;
		bignum_tabloff1 = ED.ex;
		ED.ex = EA.ex % 0x80;
		EA.ex = EA.ex / 0x80;
		bignum_tabloff2 = ED.ex;
		crc32_rotr += ED.b.lo;
		crc32_rotl -= EA.b.lo;
		namelen--;
	}

	wsprintf(serial_out, "%s", hash_ascii);
}

